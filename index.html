<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tempahan Pakej EMAS â€” Majlis 100 Tahun STS (1926â€“2026)</title>
<style>
:root{
  --header:#0f3b77; --bg:#f7f9fc; --seat-size:32px; --price:150;
  --booked:#bdbdbd; --selected:#2ecc71;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
body{margin:0;background:var(--bg);color:#0f172a}
header{background:var(--header);color:#fff;display:flex;align-items:center;gap:12px;padding:12px 18px;justify-content:space-between}
header img{height:64px;width:auto}
.header-center{flex:1;text-align:center}
.header-center h1{margin:2px 0;font-size:18px}
.header-center p{margin:0;font-size:13px;opacity:.95}
main{max-width:1200px;margin:12px auto;padding:12px}
.note{color:#374151;text-align:center;margin-bottom:12px}
.controls{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
button.primary{background:var(--header);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
button.ghost{background:#fff;border:1px solid #e6eefc;color:var(--header);padding:9px 12px;border-radius:8px;cursor:pointer}
.legend{display:flex;gap:12px;align-items:center;margin-bottom:12px;justify-content:center}
.legend span{display:inline-flex;align-items:center;gap:8px}

/* horizontal tents */
.tents-row{display:flex;gap:20px;padding:12px;overflow-x:auto;scroll-behavior:smooth}
.tent{min-width:260px;background:#fff;border-radius:12px;padding:12px;border:4px solid #e6eefc;display:flex;flex-direction:column;align-items:center}
.tent-name{font-weight:800;margin-bottom:8px}
.tent-inner{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;justify-items:center}

/* table circle */
.table-card{position:relative;width:100px;height:100px;border-radius:50%;background:#fff;border:2px solid #e2e8f0;display:flex;align-items:center;justify-content:center;margin:8px auto}
.table-center{
  width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;color:#fff;background:var(--header);border:1px solid rgba(255,255,255,0.15);z-index:3;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
}

/* seat */
.seat{position:absolute;width:var(--seat-size);height:var(--seat-size);border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:10px;border:1px solid #3b82f6;background:#fff;color:#0f172a;
  cursor:pointer;user-select:none;transform:translate(-50%,-50%);z-index:2}
.seat.booked{background:var(--booked);color:#fff;cursor:not-allowed;border-color:rgba(0,0,0,0.06)}
.seat.selected{background:var(--selected);color:#fff;border-color:var(--selected)}

footer{background:var(--header);color:#fff;text-align:center;padding:12px;margin-top:16px}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:80}
.modal{width:560px;background:#fff;border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(2,6,23,.3);max-height:90vh;overflow:auto}
.field{margin-bottom:8px}
label{display:block;font-size:13px;margin-bottom:6px}
input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc}
.small{font-size:13px;color:#475569}
#adminList{max-height:380px;overflow:auto;margin-top:10px;border:1px solid #e5e7eb;padding:6px;border-radius:8px;background:#fafafa;font-size:13px;white-space:pre-wrap}

@media(max-width:900px){
  .tent{min-width:220px}
  header img{height:48px}
  .modal{width:92%}
}
</style>
</head>
<body>

<header>
  <img src="logo_sts.png" alt="Logo STS" onerror="this.style.display='none'">
  <div class="header-center">
    <h1>Tempahan Pakej EMAS â€” Majlis 100 Tahun (1926â€“2026)</h1>
    <p>Hubungi Urusetia Alumni STS: 011-55742917 (Cg Azlan) / 011-21441240 (Cg Ajul)</p>
  </div>
  <img src="logo_100yrs.png" alt="Logo 100 Tahun STS" onerror="this.style.display='none'">
</header>

<main>
  <div class="note">Pakej EMAS â€” Harga RM150/kerusi. Sila pilih kerusi kosong, isi borang dan sahkan. Pastikan No. Resit sah dari Admin.</div>

  <div class="controls">
    <button class="primary" id="openBookingBtn">ðŸª‘ Buat Tempahan</button>
    <button class="ghost" id="refreshBtn">ðŸ”„ Muat Semula</button>
    <button class="ghost" id="downloadBtn">ðŸ’¾ Muat Turun CSV (Local)</button>
    <button class="ghost" id="adminViewBtn">ðŸ”’ Paparan Admin</button>
  </div>

  <div class="legend">
    <span><span style="width:14px;height:14px;border:1px solid #3b82f6;border-radius:3px;background:#fff"></span> Kosong</span>
    <span><span style="width:14px;height:14px;background:var(--selected);border-radius:3px"></span> Dipilih</span>
    <span><span style="width:14px;height:14px;background:var(--booked);border-radius:3px"></span> Telah Ditempah</span>
  </div>

  <div class="tents-row" id="tentsRow"></div>
</main>

<!-- Booking modal -->
<div class="modal-backdrop" id="bookingBackdrop">
  <div class="modal">
    <h3>Borang Tempahan (Pakej B)</h3>
    <form id="bookingForm">
      <div class="field"><label>Nama Penuh</label><input id="fName" required></div>
      <div class="field"><label>No. Telefon</label><input id="fPhone" required></div>
      <div class="field"><label>Batch / Tahun</label><input id="fBatch" required></div>
      <div class="field"><label>No. Resit STS100Bxxx</label><input id="fResit" placeholder="STS100B001" required></div>
      <div id="selectedSummary" class="small">Tiada kerusi dipilih.</div>
      <div style="text-align:right;margin-top:10px">
        <button type="button" class="ghost" id="bookingCancel">Batal</button>
        <button type="submit" class="primary">Sahkan Tempahan</button>
      </div>
    </form>
  </div>
</div>

<!-- Admin modal -->
<div class="modal-backdrop" id="adminBackdrop">
  <div class="modal">
    <h3>Paparan Admin</h3>
    <div class="field"><label>Kata Laluan Admin</label><input id="adminPass" type="password"></div>
    <div style="text-align:right">
      <button class="ghost" id="adminCancel">Tutup</button>
      <button class="primary" id="adminLogin">Log Masuk</button>
    </div>
    <div id="adminList" style="display:none"></div>
    <p class="small" style="margin-top:8px">(Kata laluan admin: <strong>STSADMIN2025</strong>)</p>
  </div>
</div>

<footer>Â© 2026 Sekolah Tinggi Segamat â€” Tempahan Pakej EMAS</footer>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxrXUqFSYRqeU4t3zeOJTKITc8xBNN13kpec5sPICiv2-cVKPml29lzsaA53hxspbTn/exec";
const TENTS = ['O','N','M','L','K'];
const MEJA_PER_TENT = 4;
const SEATS_PER_TABLE = 8;
const PRICE = 150;
const ADMIN_PASS = 'STSADMIN2025';
let selectedSeats = new Set();
let serverBooked = new Set();

function $(s,ctx=document){return ctx.querySelector(s);}

/* bina khemah */
function buildTentsRow(){
  const row=$('#tentsRow'); row.innerHTML='';
  TENTS.forEach(k=>{
    const tent=document.createElement('div'); tent.className='tent';
    tent.innerHTML=`<div class="tent-name">Khemah ${k}</div><div class="tent-inner"></div>`;
    const inner=tent.querySelector('.tent-inner');
    for(let m=1;m<=MEJA_PER_TENT;m++){
      const table=document.createElement('div'); table.className='table-card';
      const center=document.createElement('div'); center.className='table-center'; center.textContent='T'+m; table.appendChild(center);
      const cx=50,cy=50,r=38;
      for(let s=1;s<=SEATS_PER_TABLE;s++){
        const ang=(s-1)*(2*Math.PI/SEATS_PER_TABLE);
        const x=cx+Math.cos(ang)*r, y=cy+Math.sin(ang)*r;
        const seat=document.createElement('div'); seat.className='seat';
        seat.style.left=x+'px'; seat.style.top=y+'px';
        const seatId=`${k}-T${m}-S${s}`, seatCode=`${k}${m}${s}`;
        seat.dataset.seatid=seatId; seat.dataset.code=seatCode; seat.textContent=seatCode;
        seat.addEventListener('click',onSeatClick);
        table.appendChild(seat);
      }
      inner.appendChild(table);
    }
    row.appendChild(tent);
  });
  markBookedAndSelected();
}

/* tanda kerusi */
function markBookedAndSelected(){
  document.querySelectorAll('.seat').forEach(el=>{
    const id=el.dataset.seatid;
    el.classList.remove('booked','selected');
    if(serverBooked.has(id)) el.classList.add('booked');
    else if(selectedSeats.has(id)) el.classList.add('selected');
  });
  updateSelectedSummary();
}
function onSeatClick(e){
  const el=e.currentTarget;
  if(el.classList.contains('booked')) return alert('Kerusi telah ditempah.');
  const id=el.dataset.seatid;
  if(selectedSeats.has(id)) selectedSeats.delete(id); else selectedSeats.add(id);
  markBookedAndSelected();
}
function updateSelectedSummary(){
  const el=$('#selectedSummary');
  el.textContent = selectedSeats.size===0 ? 'Tiada kerusi dipilih.' :
  `Kerusi dipilih: ${Array.from(selectedSeats).map(i=>i.replace(/-T|S/g,'')).join(', ')} â€” Jumlah RM${selectedSeats.size*PRICE}`;
}

/* muat data ditempah */
async function loadBookedFromServer(){
  try{
    const resp=await fetch(WEBAPP_URL+'?action=getAll'); const data=await resp.json(); const seats=new Set();
    data.forEach(r=>{const code=(r.seat||r[1]||'').trim(); if(code){const k=code[0], m=code[1], s=code[2]; seats.add(`${k}-T${m}-S${s}`)}});
    serverBooked=seats; markBookedAndSelected();
  }catch(e){console.error(e);}
}

/* hantar tempahan */
async function submitBooking(){
  if(selectedSeats.size===0)return alert('Pilih sekurang-kurangnya satu kerusi.');
  const name=$('#fName').value.trim(), phone=$('#fPhone').value.trim(), batch=$('#fBatch').value.trim(), resit=$('#fResit').value.trim().toUpperCase();
  if(!/^STS100B\d{3}$/.test(resit))return alert('âš ï¸ Nombor resit tidak sah untuk Pakej B.');
  const code='STS100B-'+Math.random().toString(36).slice(2,8).toUpperCase();
  let ok=0;
  for(const seatId of selectedSeats){
    const [k,t,s]=seatId.split('-'); const meja=t.replace('T',''); const kerusi=s.replace('S','');
    const p=new URLSearchParams({nama:name,telefon:phone,batch:batch,resit:resit,khemah:k,meja:meja,kerusi:kerusi,harga:PRICE});
    const r=await fetch(WEBAPP_URL+'?'+p.toString()); const tRes=(await r.text()).trim();
    if(tRes.includes('OK'))ok++;
  }
  if(ok>0)alert(`âœ… Tempahan berjaya untuk ${ok} kerusi.`); else alert('âŒ Tiada tempahan berjaya.');
  selectedSeats.clear(); $('#bookingBackdrop').style.display='none'; loadBookedFromServer();
}

/* admin */
$('#openBookingBtn').onclick=()=>{$('#bookingBackdrop').style.display='flex'; updateSelectedSummary();};
$('#bookingCancel').onclick=()=>$('#bookingBackdrop').style.display='none';
$('#refreshBtn').onclick=()=>loadBookedFromServer();
$('#adminViewBtn').onclick=()=>{$('#adminBackdrop').style.display='flex';$('#adminList').style.display='none';};
$('#adminCancel').onclick=()=>$('#adminBackdrop').style.display='none';
$('#bookingForm').onsubmit=e=>{e.preventDefault();submitBooking();};

$('#adminLogin').onclick=async()=>{
  const val=$('#adminPass').value.trim();
  if(val!==ADMIN_PASS)return alert('Kata laluan salah.');
  try{
    const resp=await fetch(WEBAPP_URL+'?action=getAll'); const data=await resp.json();
    if(!Array.isArray(data)||data.length===0)return alert('Tiada tempahan.');
    const list=data.map(r=>{
      const tarikh=r[0], kod=r[1], unik=r[2], nama=r[3], resit=r[6];
      return `${resit} â€” ${nama} â€” ${kod} â€” ${unik} â€” ${tarikh}`;
    }).join('\n');
    $('#adminList').style.display='block'; $('#adminList').textContent='ðŸ“‹ Senarai Resit Digunakan:\n\n'+list;
  }catch(err){alert('Gagal muat data admin: '+err);}
};

document.addEventListener('DOMContentLoaded',()=>{buildTentsRow();loadBookedFromServer();setInterval(loadBookedFromServer,30000);});
</script>
</body>
</html>
