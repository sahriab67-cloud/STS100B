<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tempahan_STS100B — Majlis 100 Tahun STS (1926–2026)</title>
<style>
:root{
  --header:#0f3b77;--bg:#f7f9fc;--seat-size:32px;
  --booked:#bdbdbd;--selected:#2ecc71;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
body{margin:0;background:var(--bg);color:#0f172a}
header{background:var(--header);color:#fff;display:flex;align-items:center;gap:12px;padding:12px 18px;justify-content:space-between}
header img{height:72px;width:auto}
.header-center{flex:1;text-align:center}
.header-center h1{margin:4px 0;font-size:18px}
.header-center p{margin:0;font-size:13px;opacity:.95}
main{max-width:1200px;margin:16px auto;padding:12px}
.note{margin-bottom:12px;color:#374151}
.legend{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.legend span{display:inline-flex;align-items:center;gap:6px}
.tents-layout{display:flex;justify-content:center;gap:20px;flex-wrap:wrap}
.tent{width:220px;padding:10px;border-radius:10px;position:relative;min-height:240px;
       display:flex;flex-direction:column;align-items:center;background:#e0f2fe;border:4px solid #3b82f6}
.tent-name{font-weight:700;text-align:center;margin-bottom:8px}
.tent-inner{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;justify-items:center}
.table-card{position:relative;width:100px;height:100px;border-radius:50%;
            background:#fff;border:2px solid #e2e8f0;display:flex;align-items:center;justify-content:center;margin:auto}
.table-center{width:28px;height:28px;border-radius:50%;background:#fff;border:1px solid #cbd5e1;
              display:flex;align-items:center;justify-content:center;font-size:11px}
.seat{position:absolute;width:var(--seat-size);height:var(--seat-size);border-radius:50%;
      display:flex;align-items:center;justify-content:center;font-size:10px;border:1px solid #3b82f6;
      background:#fff;color:#0f172a;cursor:pointer;user-select:none;transform:translate(-50%,-50%)}
.seat.booked{background:var(--booked);color:#fff;cursor:not-allowed}
.seat.selected{background:var(--selected);color:#fff}
.controls{display:flex;gap:10px;align-items:center;justify-content:center;margin:12px 0;flex-wrap:wrap}
button.primary{background:var(--header);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
button.ghost{background:#fff;border:1px solid #e6eefc;color:var(--header);padding:9px 12px;border-radius:8px;cursor:pointer}
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:520px;background:#fff;border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(2,6,23,.3)}
.field{margin-bottom:10px}
label{display:block;font-size:13px;margin-bottom:4px}
input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc}
.small{font-size:13px;color:#475569}
footer{background:var(--header);color:#fff;text-align:center;padding:12px;margin-top:18px}
@media(max-width:960px){.tent{width:45%}.modal{width:92%}}
</style>
</head>
<body>
<header>
  <img src="logo_sts.png" alt="Logo STS" onerror="this.style.display='none'">
  <div class="header-center">
    <h1>Tempahan STS100B — Majlis 100 Tahun (1926–2026)</h1>
    <p>Hubungi Urusetia Alumni STS: 011-55742917 (Cg Azlan) / 011-21441240 (Cg Ajul)</p>
  </div>
  <img src="logo_100yrs.png" alt="Logo 100 Tahun STS" onerror="this.style.display='none'">
</header>

<main>
  <div class="note">Sila pilih kerusi yang kosong. Harga RM150 / kerusi.</div>
  <div class="controls">
    <button class="primary" id="openBookingBtn">Buka Borang Tempahan</button>
    <button class="ghost" id="downloadAllBtn">💾 Muat Turun Semua Tempahan (CSV)</button>
    <button class="ghost" id="adminViewBtn">🔒 Paparan Admin</button>
  </div>

  <div class="legend">
    <span><span style="width:16px;height:16px;background:#fff;border:1px solid #3b82f6;border-radius:3px;"></span> Kosong</span>
    <span><span style="width:16px;height:16px;background:#2ecc71;border-radius:3px;"></span> Dipilih</span>
    <span><span style="width:16px;height:16px;background:#bdbdbd;border-radius:3px;"></span> Telah Ditempah</span>
  </div>

  <div class="tents-layout" id="tentsContainer"></div>
</main>

<!-- Modal Borang -->
<div class="modal-backdrop" id="bookingBackdrop">
  <div class="modal">
    <h3>Borang Tempahan</h3>
    <form id="bookingForm">
      <div class="field"><label>Nama Penuh</label><input id="fName" required></div>
      <div class="field"><label>No. Telefon</label><input id="fPhone" required></div>
      <div class="field"><label>Batch / Tahun</label><input id="fBatch" required></div>
      <div class="field"><label>No. Resit / Rujukan (jika ada)</label><input id="fResit"></div>
      <div class="field small" id="selectedSummary">Tiada kerusi dipilih.</div>
      <div style="text-align:right">
        <button type="button" class="ghost" id="bookingCancel">Batal</button>
        <button type="submit" class="primary">Sahkan Tempahan & Hantar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Admin -->
<div class="modal-backdrop" id="adminBackdrop">
  <div class="modal">
    <h3>Paparan Admin</h3>
    <div class="field"><label>Kata Laluan Admin</label><input id="adminPass" type="password"></div>
    <div style="text-align:right">
      <button class="ghost" id="adminCancel">Tutup</button>
      <button class="primary" id="adminLogin">Log Masuk</button>
    </div>
    <p class="small">(Kata laluan: STSADMIN2025)</p>
  </div>
</div>

<footer>© 2026 Sekolah Tinggi Segamat — Tempahan STS100B (Pakej B)</footer>

<script>
const WEBAPP_URL='https://script.google.com/macros/s/AKfycbyFsab2GJLCFcpxVe-niCMTWx-XlyV9NcvCPkzlu4G-Us9dFxPKfe-d2JXtr3DenU-M/exec';
const PRICE=150;
const MEJA_PER_KHEMAH=4;
const SEATS_PER_TABLE=8;
const TENTS=['O','N','M','L','K'];
const ADMIN_PASS='STSADMIN2025';
let selectedSeats=new Set(),serverBooked=new Set();

const $=(s,ctx=document)=>ctx.querySelector(s);
function updateSelectedSummary(){
  const el=$('#selectedSummary');
  el.textContent=selectedSeats.size?`Kerusi dipilih: ${[...selectedSeats].join(', ')} — RM${selectedSeats.size*PRICE}`:'Tiada kerusi dipilih.';
}

function buildLayout(){
  const container=$('#tentsContainer');container.innerHTML='';
  TENTS.forEach(k=>{
    const tent=document.createElement('div');
    tent.className='tent';tent.innerHTML=`<div class="tent-name">Khemah ${k}</div><div class="tent-inner"></div>`;
    const inner=tent.querySelector('.tent-inner');
    for(let m=1;m<=MEJA_PER_KHEMAH;m++){
      const table=document.createElement('div');table.className='table-card';
      const center=document.createElement('div');center.className='table-center';center.textContent='T'+m;table.appendChild(center);
      const radius=35;
      for(let s=1;s<=SEATS_PER_TABLE;s++){
        const seatId=`${k}-T${m}-S${s}`;
        const ang=(s-1)*(360/SEATS_PER_TABLE)*Math.PI/180;
        const x=50+radius*Math.cos(ang),y=50+radius*Math.sin(ang);
        const seat=document.createElement('div');
        seat.className='seat';seat.style.left=x+'px';seat.style.top=y+'px';
        seat.dataset.seatid=seatId;seat.dataset.short=`${k}${m}${s}`;
        seat.textContent=seat.dataset.short;
        seat.onclick=()=>{if(seat.classList.contains('booked'))return;
          if(selectedSeats.has(seatId)){selectedSeats.delete(seatId);seat.classList.remove('selected');}
          else{selectedSeats.add(seatId);seat.classList.add('selected');}
          updateSelectedSummary();
        };
        table.appendChild(seat);
      }
      inner.appendChild(table);
    }
    container.appendChild(tent);
  });
}

async function loadBookedFromServer(){
  try{
    const r=await fetch(WEBAPP_URL+'?action=getAll');
    const data=await r.json();
    serverBooked=new Set(data.map(v=>{
      const c=String(v.seat||'');if(!c)return'';const k=c[0],rest=c.slice(1);
      if(rest.length<2)return'';const m=rest[0],s=rest.slice(1);
      return`${k}-T${m}-S${s}`;
    }));
    markBookedAndSelected();
  }catch(e){console.warn('Gagal muat data server',e);}
}
function markBookedAndSelected(){
  document.querySelectorAll('.seat').forEach(seat=>{
    if(serverBooked.has(seat.dataset.seatid))seat.classList.add('booked');
  });
}

/* ========== BORANG ========== */
$('#openBookingBtn').onclick=()=>{$('#bookingBackdrop').style.display='flex';updateSelectedSummary();}
$('#bookingCancel').onclick=()=>{$('#bookingBackdrop').style.display='none';}
$('#bookingForm').onsubmit=async e=>{
  e.preventDefault();
  if(!selectedSeats.size)return alert('Pilih sekurang-kurangnya satu kerusi.');
  const nama=$('#fName').value.trim(),tel=$('#fPhone').value.trim(),batch=$('#fBatch').value.trim(),resit=$('#fResit').value.trim();
  if(!nama||!tel||!batch)return alert('Isi Nama, Telefon dan Batch.');
  for(const seat of selectedSeats){
    const[k,m,s]=seat.split('-');
    const params=new URLSearchParams({nama,tel,batch,resit,khemah:k,meja:m.replace('T',''),kerusi:s.replace('S',''),harga:PRICE});
    const resp=await fetch(WEBAPP_URL+'?'+params.toString());const txt=await resp.text();
    if(txt.includes('OK')){serverBooked.add(seat);}else alert('⚠️ '+txt);
  }
  alert('✅ Tempahan dihantar.');
  selectedSeats.clear();$('#bookingBackdrop').style.display='none';buildLayout();markBookedAndSelected();
};

/* ========== ADMIN ========== */
$('#adminViewBtn').onclick=()=>{$('#adminBackdrop').style.display='flex';}
$('#adminCancel').onclick=()=>{$('#adminBackdrop').style.display='none';}
$('#adminLogin').onclick=()=>{
  const pw=$('#adminPass').value;
  if(pw!==ADMIN_PASS)return alert('Kata laluan salah.');
  $('#adminBackdrop').style.display='none';
  alert('Paparan Admin: fungsi eksport CSV tersedia.');
};
$('#downloadAllBtn').onclick=()=>{
  const rows=[['Kod','Khemah','Meja','Kerusi']];
  serverBooked.forEach(s=>{const[k,m,sn]=s.split('-');rows.push([`${k}${m.replace('T','')}${sn.replace('S','')}`,k,m.replace('T',''),sn.replace('S','')]);});
  const csv=rows.map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='Tempahan_STS100B.csv';a.click();
};
buildLayout();loadBookedFromServer();
</script>
</body>
</html>
