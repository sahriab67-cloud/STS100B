<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tempahan_STS100B ‚Äî Pakej B (Majlis 100 Tahun)</title>
<style>
:root{
  --header:#0f3b77; --bg:#f7f9fc; --seat-size:32px; --price:150;
  --booked:#bdbdbd; --selected:#2ecc71;
  --tent-bg:#eef2ff;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
body{margin:0;background:var(--bg);color:#0f172a}
header{background:var(--header);color:#fff;display:flex;align-items:center;gap:12px;padding:12px 18px;justify-content:space-between}
.header-center{flex:1;text-align:center}
.header-center h1{margin:4px 0;font-size:18px}
main{max-width:1200px;margin:16px auto;padding:12px}
.note{color:#374151;margin-bottom:12px;text-align:center}
.controls{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:12px}
button.primary{background:var(--header);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
button.ghost{background:#fff;border:1px solid #e6eefc;color:var(--header);padding:9px 12px;border-radius:8px;cursor:pointer}

/* single-row tents */
.tents-row{display:flex;gap:18px;overflow-x:auto;padding:6px 12px}
.tent{min-width:240px;background:#fff;border-radius:12px;padding:12px;border:4px solid #e6eefc;display:flex;flex-direction:column;align-items:center}
.tent-name{font-weight:800;margin-bottom:8px}
.tent-inner{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;justify-items:center;width:100%}
.table-slot{width:100px;height:100px;border-radius:50%;position:relative;background:#f9fafb;border:2px solid #e2e8f0;display:flex;align-items:center;justify-content:center}
.table-center{width:34px;height:34px;border-radius:50%;background:#fff;border:1px solid #cbd5e1;display:flex;align-items:center;justify-content:center;font-size:12px;z-index:3}
.seat{position:absolute;width:var(--seat-size);height:var(--seat-size);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;border:1px solid #3b82f6;background:#fff;color:#0f172a;cursor:pointer;transform:translate(-50%,-50%)}
.seat.booked{background:var(--booked);color:#fff;cursor:not-allowed}
.seat.selected{background:var(--selected);color:#fff}

footer{background:var(--header);color:#fff;text-align:center;padding:12px;margin-top:18px}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal{width:520px;background:#fff;border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(2,6,23,.3)}
.field{margin-bottom:8px}
label{display:block;font-size:13px;margin-bottom:6px}
input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc}
.invalid-resit{color:#9b1c1c;margin-top:6px;font-weight:700;display:none}
@media(max-width:640px){ .tents-row{padding:6px} .tent{min-width:200px} .modal{width:92%} }
</style>
</head>
<body>

<header>
  <div class="header-center">
    <h1>Tempahan STS100B ‚Äî Pakej B (Majlis 100 Tahun)</h1>
    <p>Hubungi Urusetia: 011-55742917(Cg Azlan)/011-21441240(Cg Ajul)</p>
  </div>
</header>

<main>
  <div class="note">Pakej B: Harga RM150/kerusi. Susunan khemah (sebaris): O ‚Äî N ‚Äî M ‚Äî L ‚Äî K. Khemah & meja seperti Pakej A.</div>

  <div class="controls">
    <button class="primary" id="openBookingBtn">ü™ë Buat Tempahan</button>
    <button class="ghost" id="refreshBtn">üîÑ Muat Semula</button>
    <button class="ghost" id="downloadBtn">üíæ Muat Turun Semua (CSV)</button>
  </div>

  <div class="tents-row" id="tentsRow" aria-live="polite"></div>
</main>

<!-- Booking modal -->
<div class="modal-backdrop" id="bookingBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Borang Tempahan (Pakej B)</h3>
    <form id="bookingForm">
      <div class="field"><label>Nama Penuh</label><input id="fName" required></div>
      <div class="field"><label>No. Telefon</label><input id="fPhone" required></div>
      <div class="field"><label>Batch / Tahun</label><input id="fBatch" required></div>
      <div class="field"><label>No. Resit (STS100Bxxx)</label><input id="fResit" required placeholder="STS100B001"></div>
      <div id="resitError" class="invalid-resit">‚ö†Ô∏è Nombor resit tidak sah untuk Pakej B. Sila hubungi urusetia.</div>
      <div class="field" id="selectedSummary">Tiada kerusi dipilih.</div>
      <div style="text-align:right">
        <button type="button" class="ghost" id="cancelBooking">Batal</button>
        <button type="submit" class="primary" id="confirmBooking">Sahkan Tempahan</button>
      </div>
    </form>
  </div>
</div>

<footer>¬© 2026 Sekolah Tinggi Segamat ‚Äî Tempahan STS100B</footer>

<script>
/* ---------- CONFIG ---------- */
/* Gantikan WEBAPP_URL dengan URL exec Web App Pakej B setelah deploy */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzetI78Qg_QoayIVmAVA6tD1j2oTPnCs3b_aD3oaZ3z6zDmRKqsQtVJKTDtDEZ4-2_M/exec'; // <-- paste URL /exec di sini selepas deploy
const TENTS = ['O','N','M','L','K']; // sebaris
const MEJA_PER_TENT = 4;
const SEATS_PER_TABLE = 8;
const PRICE = 150;

/* helpers */
const $ = (s, ctx=document) => ctx.querySelector(s);

let selectedSeats = new Set();
let serverBooked = new Set();

/* build tents row */
function buildTentsRow(){
  const row = $('#tentsRow');
  row.innerHTML = '';
  for(const t of TENTS){
    const tent = document.createElement('div');
    tent.className = 'tent';
    tent.innerHTML = `<div class="tent-name">Khemah ${t}</div><div class="tent-inner"></div>`;
    const inner = tent.querySelector('.tent-inner');

    for(let table=1; table<=MEJA_PER_TENT; table++){
      const slot = document.createElement('div');
      slot.className = 'table-slot';
      const center = document.createElement('div'); center.className='table-center'; center.textContent='T'+table;
      slot.appendChild(center);

      const cx = 50, cy = 50, radius = 38;
      for(let s=1;s<=SEATS_PER_TABLE;s++){
        const angle = (s-1)*(2*Math.PI/SEATS_PER_TABLE);
        const x = cx + Math.cos(angle)*radius;
        const y = cy + Math.sin(angle)*radius;
        const seat = document.createElement('div');
        seat.className = 'seat';
        const id = `${t}-T${table}-S${s}`;
        seat.style.left = x + 'px'; seat.style.top = y + 'px';
        seat.textContent = `${t}${table}${s}`;
        seat.dataset.seatid = id;
        seat.dataset.tent = t;
        seat.dataset.table = table;
        seat.dataset.seat = s;
        seat.title = `Khemah ${t} ‚Äî Meja ${table} ‚Äî Kerusi ${s}`;
        seat.addEventListener('click', onSeatClick);
        slot.appendChild(seat);
      }

      inner.appendChild(slot);
    }

    row.appendChild(tent);
  }

  markBookedAndSelected();
}

function markBookedAndSelected(){
  document.querySelectorAll('.seat').forEach(el=>{
    const id = el.dataset.seatid;
    el.classList.remove('booked','selected');
    if(serverBooked.has(id)) el.classList.add('booked');
    else if(selectedSeats.has(id)) el.classList.add('selected');
  });
  updateSummary();
}

function onSeatClick(e){
  const el = e.currentTarget;
  if(el.classList.contains('booked')){ alert('Maaf, kerusi telah ditempah.'); return; }
  const id = el.dataset.seatid;
  if(selectedSeats.has(id)){ selectedSeats.delete(id); el.classList.remove('selected'); }
  else { selectedSeats.add(id); el.classList.add('selected'); }
  updateSummary();
}

function updateSummary(){
  const sum = $('#selectedSummary');
  if(!sum) return;
  if(selectedSeats.size===0) sum.textContent = 'Tiada kerusi dipilih.';
  else sum.textContent = `Kerusi dipilih: ${Array.from(selectedSeats).join(', ')} ‚Äî Jumlah RM${selectedSeats.size * PRICE}`;
}

/* load bookings from server (JSONP fallback to /?action=load&callback=) */
function handleServerBookings(data){
  serverBooked.clear();
  if(Array.isArray(data)){
    data.forEach(r=>{
      if(r.khemah && r.meja && r.kerusi){
        const sid = `${r.khemah}-T${r.meja}-S${r.kerusi}`;
        serverBooked.add(sid);
      } else if(r.kodKerusi){
        serverBooked.add(r.kodKerusi);
      }
    });
  }
  markBookedAndSelected();
}

function loadBookingsFromServer(){
  if(!WEBAPP_URL){ console.warn('WEBAPP_URL kosong ‚Äî sila paste URL /exec pada bahagian atas HTML'); return; }
  const cbName = 'handleServerBookings';
  window[cbName] = handleServerBookings;
  const s = document.createElement('script');
  s.src = WEBAPP_URL + '?action=load&callback=' + cbName + '&_=' + Date.now();
  s.onerror = ()=>{ console.warn('Gagal load bookings via JSONP'); };
  document.body.appendChild(s);
  setTimeout(()=>{ try{ document.body.removeChild(s);}catch(e){} },15000);
}

/* resit validation (client-side) */
function isValidResitB(r){
  if(!r) return false;
  const u = r.trim().toUpperCase();
  if(!u.startsWith('STS100B')) return false;
  const num = u.slice(7);
  if(!/^\d{3}$/.test(num)) return false;
  const v = parseInt(num,10);
  return v>=1 && v<=160;
}

/* submit booking: send GET no-cors per seat */
async function submitBooking(){
  if(selectedSeats.size === 0){ alert('Sila pilih sekurang-kurangnya satu kerusi.'); return; }
  const name = $('#fName').value.trim(), phone = $('#fPhone').value.trim(), batch = $('#fBatch').value.trim();
  const resitRaw = $('#fResit').value.trim().toUpperCase();
  $('#resitError').style.display = 'none';
  if(!name||!phone||!batch){ alert('Sila lengkapkan maklumat.'); return; }
  if(!isValidResitB(resitRaw)){ $('#resitError').style.display='block'; alert('‚ö†Ô∏è Nombor resit tidak sah untuk Pakej B.'); return; }
  if(!WEBAPP_URL){ alert('WEBAPP_URL belum ditetapkan. Sila kemaskini HTML dengan URL Web App.'); return; }

  const code = 'STS100B-' + Math.random().toString(36).slice(2,8).toUpperCase();
  let sent = 0;
  const seatsArr = Array.from(selectedSeats);
  for(const seat of seatsArr){
    const parts = seat.split('-');
    const khemah = parts[0], meja = parts[1].replace('T',''), kerusi = parts[2].replace('S','');
    const payload = {
      nama: name, telefon: phone, batch: batch, resit: resitRaw,
      khemah: khemah, meja: meja, kerusi: kerusi, kod_tempahan: code, harga: PRICE, masa: new Date().toISOString()
    };
    const params = new URLSearchParams(payload);
    const url = WEBAPP_URL + '?' + params.toString();
    try{
      await fetch(url, { method: 'GET', mode: 'no-cors' });
      sent++;
    } catch(err){
      console.error('Fetch error', err);
    }
  }

  if(sent>0){
    alert(`‚úÖ Tempahan dihantar (${sent} kerusi). Kod: ${code}.`);
    selectedSeats.clear();
    updateSummary();
    setTimeout(()=>{ loadBookingsFromServer(); },1200);
    $('#bookingBackdrop').style.display='none';
  } else {
    alert('‚ö†Ô∏è Gagal menghantar. Sila cuba lagi.');
  }
}

/* DOM bindings */
$('#openBookingBtn').addEventListener('click', ()=>{ $('#bookingBackdrop').style.display='flex'; $('#fName').focus(); updateSummary(); });
$('#cancelBooking').addEventListener('click', ()=>{ $('#bookingBackdrop').style.display='none'; });
$('#refreshBtn').addEventListener('click', ()=>{ loadBookingsFromServer(); });
$('#downloadBtn').addEventListener('click', ()=>{ if(!WEBAPP_URL) { alert('WEBAPP_URL kosong'); return; } window.open(WEBAPP_URL + '?action=export', '_blank'); });
$('#bookingForm').addEventListener('submit', ev=>{ ev.preventDefault(); submitBooking(); });

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  buildTentsRow();
  loadBookingsFromServer();
});
</script>
</body>
</html>
