<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tempahan STS100B — Majlis 100 Tahun STS</title>
<style>
  :root{
    --header:#0f3b77; --bg:#f7f9fc; --seat-size:30px;
    --booked:#bdbdbd; --selected:#2ecc71;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
  body{margin:0;background:var(--bg);color:#0f172a}
  header{background:var(--header);color:#fff;text-align:center;padding:12px}
  header h1{margin:0;font-size:18px}
  main{max-width:1100px;margin:auto;padding:12px}
  .legend{display:flex;gap:10px;justify-content:center;margin:10px 0}
  .legend span{display:flex;align-items:center;gap:4px}
  .tents-layout{display:grid;grid-template-columns:repeat(5,1fr);gap:20px;justify-items:center}
  .tent{background:#fff;border:3px solid #3b82f6;border-radius:10px;padding:8px;width:200px;text-align:center}
  .tent-inner{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;justify-items:center}
  .table{position:relative;width:90px;height:90px;border-radius:50%;border:2px solid #e2e8f0;margin:auto;background:#fafafa}
  .table-center{width:26px;height:26px;border-radius:50%;background:#fff;border:1px solid #ccc;
                display:flex;align-items:center;justify-content:center;font-size:11px;position:absolute;
                top:50%;left:50%;transform:translate(-50%,-50%)}
  .seat{position:absolute;width:var(--seat-size);height:var(--seat-size);border-radius:50%;
        border:1px solid #3b82f6;background:#fff;font-size:9px;display:flex;align-items:center;
        justify-content:center;transform:translate(-50%,-50%);cursor:pointer}
  .seat.booked{background:var(--booked);color:#fff;cursor:not-allowed}
  .seat.selected{background:var(--selected);color:#fff}
  .controls{text-align:center;margin:10px}
  button{background:var(--header);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
  .modal{background:#fff;border-radius:8px;padding:16px;width:320px}
  footer{text-align:center;background:var(--header);color:#fff;padding:10px;margin-top:20px}
</style>
</head>
<body>
<header><h1>Tempahan STS100B — Majlis 100 Tahun STS (1926–2026)</h1></header>

<main>
  <div class="legend">
    <span><span style="width:14px;height:14px;border:1px solid #3b82f6"></span>Kosong</span>
    <span><span style="width:14px;height:14px;background:#2ecc71"></span>Dipilih</span>
    <span><span style="width:14px;height:14px;background:#bdbdbd"></span>Telah Ditempah</span>
  </div>
  <div class="controls"><button id="openForm">Tempah Kerusi</button></div>
  <div class="tents-layout" id="tents"></div>
</main>

<!-- Popup -->
<div class="modal-backdrop" id="popup">
  <div class="modal">
    <h3>Borang Tempahan</h3>
    <form id="form">
      <input id="nama" placeholder="Nama Penuh" required style="width:100%;margin:5px 0">
      <input id="telefon" placeholder="No Telefon" required style="width:100%;margin:5px 0">
      <input id="batch" placeholder="Batch / Tahun" required style="width:100%;margin:5px 0">
      <input id="resit" placeholder="No Resit STS100B001-160" required style="width:100%;margin:5px 0">
      <div id="summary" style="font-size:13px;color:#555;margin:5px 0">Tiada kerusi dipilih.</div>
      <div style="text-align:right">
        <button type="button" onclick="closePopup()">Batal</button>
        <button type="submit">Hantar</button>
      </div>
    </form>
  </div>
</div>

<footer>© 2026 Sekolah Tinggi Segamat — Pakej B (RM150 / kerusi)</footer>

<script>
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbzAQrrVdAfIwepWTLK060v9qv_I0y-bpjBvmXyeWuSauHqIlFh23X2RCZNDBRPUNBD7/exec";
const PRICE=150,MEJA=4,KERUSI=8;
const khemahList=["O","N","M","L","K"];
const tents=document.getElementById("tents");
let selected=new Set(),booked=new Set();

/* ---------- Dapatkan data tempahan sedia ada ---------- */
fetch(WEBAPP_URL+"?action=getAll").then(r=>r.json()).then(d=>{
  booked=new Set(d.map(x=>x.seat));
  build();
});

function build(){
  tents.innerHTML="";
  for(const k of khemahList){
    const t=document.createElement("div");
    t.className="tent";
    t.innerHTML=`<h4>Khemah ${k}</h4><div class='tent-inner'></div>`;
    const inner=t.querySelector(".tent-inner");
    for(let m=1;m<=MEJA;m++){
      const tb=document.createElement("div");
      tb.className="table";
      const c=document.createElement("div");
      c.className="table-center";c.textContent=m;
      tb.appendChild(c);
      const R=35;
      for(let s=1;s<=KERUSI;s++){
        const id=`${k}-T${m}-S${s}`;
        const code=`${k}${m}${s}`;
        const ang=(s-1)*(360/KERUSI)*Math.PI/180;
        const seat=document.createElement("div");
        seat.className="seat";
        if(booked.has(id)) seat.classList.add("booked");
        seat.style.left=45+R*Math.cos(ang)+"px";
        seat.style.top=45+R*Math.sin(ang)+"px";
        seat.textContent=code;
        seat.onclick=()=>toggleSeat(id,seat);
        tb.appendChild(seat);
      }
      inner.appendChild(tb);
    }
    tents.appendChild(t);
  }
}

function toggleSeat(id,el){
  if(el.classList.contains("booked")) return alert("Kerusi telah ditempah.");
  if(selected.has(id)){selected.delete(id);el.classList.remove("selected");}
  else{selected.add(id);el.classList.add("selected");}
  updateSummary();
}

/* ---------- Popup ---------- */
const popup=document.getElementById("popup");
document.getElementById("openForm").onclick=()=>popup.style.display="flex";
function closePopup(){popup.style.display="none";}
function updateSummary(){
  const sum=document.getElementById("summary");
  if(selected.size===0) sum.textContent="Tiada kerusi dipilih.";
  else sum.textContent=`Kerusi: ${Array.from(selected).join(", ")} | Jumlah RM${selected.size*PRICE}`;
}

/* ---------- Hantar tempahan ---------- */
document.getElementById("form").onsubmit=async e=>{
  e.preventDefault();
  if(selected.size===0)return alert("Sila pilih sekurang-kurangnya 1 kerusi.");
  const nama=namaInput.value=document.getElementById("nama").value.trim();
  const telefon=document.getElementById("telefon").value.trim();
  const batch=document.getElementById("batch").value.trim();
  const resit=document.getElementById("resit").value.trim();
  const code="STS100B-"+Math.random().toString(36).substring(2,8).toUpperCase();

  for(const seat of selected){
    const [k,m,s]=seat.split("-");
    const data={nama,telefon,batch,resit,khemah:k,meja:m.replace("T",""),
                kerusi:s.replace("S",""),harga:PRICE,kod_tempahan:code};
    const qs=new URLSearchParams(data);
    const r=await fetch(WEBAPP_URL+"?"+qs.toString());
    const t=await r.text();
    if(t!=="OK") return alert("Ralat: "+t);
  }
  alert(`✅ Tempahan berjaya (${selected.size} kerusi)\nKod Tempahan: ${code}`);
  location.reload();
};
</script>
</body>
</html>
