<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tempahan STS100B â€” Majlis 100 Tahun STS (1926â€“2026)</title>
<style>
:root{
  --header:#0f3b77; --bg:#f7f9fc; --seat-size:32px; --price:150;
  --booked:#bdbdbd; --selected:#2ecc71;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
body{margin:0;background:var(--bg);color:#0f172a}
header{background:var(--header);color:#fff;display:flex;align-items:center;gap:12px;padding:12px 18px;justify-content:space-between}
header img{height:64px;width:auto}
.header-center{flex:1;text-align:center}
.header-center h1{margin:2px 0;font-size:18px}
.header-center p{margin:0;font-size:13px;opacity:.95}
main{max-width:1200px;margin:12px auto;padding:12px}
.note{color:#374151;text-align:center;margin-bottom:12px}
.controls{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
button.primary{background:var(--header);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
button.ghost{background:#fff;border:1px solid #e6eefc;color:var(--header);padding:9px 12px;border-radius:8px;cursor:pointer}
.legend{display:flex;gap:12px;align-items:center;margin-bottom:12px;justify-content:center}
.legend span{display:inline-flex;align-items:center;gap:8px}

/* horizontal single-row tents with scroll */
.tents-row{display:flex;gap:20px;padding:12px;overflow-x:auto;scroll-behavior:smooth}
.tent{min-width:260px;background:#fff;border-radius:12px;padding:12px;border:4px solid #e6eefc;display:flex;flex-direction:column;align-items:center}
.tent-name{font-weight:800;margin-bottom:8px}
.tent-inner{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;justify-items:center}

/* table circle */
.table-card{position:relative;width:100px;height:100px;border-radius:50%;background:#fff;border:2px solid #e2e8f0;display:flex;align-items:center;justify-content:center;margin:8px auto}
.table-center{
  width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;color:#fff;background:var(--header);border:1px solid rgba(255,255,255,0.15);z-index:3;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
}

/* seat */
.seat{position:absolute;width:var(--seat-size);height:var(--seat-size);border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:10px;border:1px solid #3b82f6;background:#fff;color:#0f172a;
  cursor:pointer;user-select:none;transform:translate(-50%,-50%);z-index:2}
.seat.booked{background:var(--booked);color:#fff;cursor:not-allowed;border-color:rgba(0,0,0,0.06)}
.seat.selected{background:var(--selected);color:#fff;border-color:var(--selected)}

footer{background:var(--header);color:#fff;text-align:center;padding:12px;margin-top:16px}

/* modals */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:80}
.modal{width:520px;background:#fff;border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(2,6,23,.3)}
.field{margin-bottom:8px}
label{display:block;font-size:13px;margin-bottom:6px}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc}
.small{font-size:13px;color:#475569}

@media(max-width:900px){
  .tent{min-width:220px}
  header img{height:48px}
  .modal{width:92%}
}
</style>
</head>
<body>

<header>
  <img src="logo_sts.png" alt="Logo STS" onerror="this.style.display='none'">
  <div class="header-center">
    <h1>Tempahan STS100B â€” Majlis 100 Tahun (1926â€“2026)</h1>
    <p>Hubungi Urusetia Alumni STS: 011-55742917 (Cg Azlan) / 011-21441240 (Cg Ajul)</p>
  </div>
  <img src="logo_100yrs.png" alt="Logo 100 Tahun STS" onerror="this.style.display='none'">
</header>

<main>
  <div class="note">Pakej B â€” Harga RM150/kerusi. Sila pilih kerusi kosong, isi borang dan sahkan. Pastikan No.Resit sah dari Admin.</div>

  <div class="controls">
    <button class="primary" id="openBookingBtn">ðŸª‘ Buat Tempahan</button>
    <button class="ghost" id="refreshBtn">ðŸ”„ Muat Semula</button>
    <button class="ghost" id="downloadBtn">ðŸ’¾ Muat Turun CSV (Local)</button>
    <button class="ghost" id="adminViewBtn">ðŸ”’ Paparan Admin</button>
  </div>

  <div class="legend">
    <span><span style="display:inline-block;width:14px;height:14px;border:1px solid #3b82f6;border-radius:3px;background:#fff"></span> Kosong</span>
    <span><span style="display:inline-block;width:14px;height:14px;background:var(--selected);border-radius:3px"></span> Dipilih</span>
    <span><span style="display:inline-block;width:14px;height:14px;background:var(--booked);border-radius:3px"></span> Telah Ditempah</span>
  </div>

  <div class="tents-row" id="tentsRow" aria-live="polite"></div>
</main>

<!-- Booking modal -->
<div class="modal-backdrop" id="bookingBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="bookingTitle">
    <h3 id="bookingTitle">Borang Tempahan (Pakej B)</h3>
    <form id="bookingForm">
      <div class="field"><label>Nama Penuh</label><input id="fName" required></div>
      <div class="field"><label>No. Telefon</label><input id="fPhone" required></div>
      <div class="field"><label>Batch / Tahun</label><input id="fBatch" required></div>
      <div class="field"><label>No. Resit STS100Bxxx</label><input id="fResit" placeholder="STS100B001" required></div>
      <div id="selectedSummary" class="small">Tiada kerusi dipilih.</div>
      <div style="text-align:right;margin-top:10px">
        <button type="button" class="ghost" id="bookingCancel">Batal</button>
        <button type="submit" class="primary">Sahkan Tempahan</button>
      </div>
    </form>
  </div>
</div>

<!-- Admin modal -->
<div class="modal-backdrop" id="adminBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Paparan Admin</h3>
    <div class="field"><label>Kata Laluan Admin</label><input id="adminPass" type="password" placeholder="Masukkan kata laluan"></div>
    <div style="text-align:right">
      <button class="ghost" id="adminCancel">Tutup</button>
      <button class="primary" id="adminLogin">Log Masuk</button>
    </div>
    <p class="small" style="margin-top:8px">(Kata laluan admin: <strong>STSADMIN2025</strong>)</p>
  </div>
</div>

<footer>Â© 2026 Sekolah Tinggi Segamat â€” Tempahan STS100B (Pakej B)</footer>

<script>
/* ========== CONFIG ========== */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyFsab2GJLCFcpxVe-niCMTWx-XlyV9NcvCPkzlu4G-Us9dFxPKfe-d2JXtr3DenU-M/exec";
const TENTS = ['O','N','M','L','K']; // left-to-right order
const MEJA_PER_TENT = 4;
const SEATS_PER_TABLE = 8;
const PRICE = 150;
const ADMIN_PASS = 'STSADMIN2025';

/* ========== STATE ========== */
let selectedSeats = new Set();
let serverBooked = new Set();

/* tiny selector */
const $ = (s, ctx=document) => ctx.querySelector(s);

/* ========== BUILD UI ========== */
function buildTentsRow(){
  const row = $('#tentsRow'); row.innerHTML = '';
  TENTS.forEach(k => {
    const tent = document.createElement('div'); tent.className = 'tent';
    tent.innerHTML = `<div class="tent-name">Khemah ${k}</div><div class="tent-inner"></div>`;
    const inner = tent.querySelector('.tent-inner');

    for(let m=1;m<=MEJA_PER_TENT;m++){
      const table = document.createElement('div'); table.className = 'table-card';
      const center = document.createElement('div'); center.className = 'table-center'; center.textContent = 'T'+m;
      table.appendChild(center);

      // seat positions around circle
      const cx = 50, cy = 50, radius = 38;
      for(let s=1;s<=SEATS_PER_TABLE;s++){
        const angle = (s-1)*(2*Math.PI/SEATS_PER_TABLE);
        const x = cx + Math.cos(angle)*radius;
        const y = cy + Math.sin(angle)*radius;
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.style.left = x + 'px'; seat.style.top = y + 'px';
        const seatId = `${k}-T${m}-S${s}`;           // internal id
        const seatCode = `${k}${m}${s}`;             // displayed code like K17
        seat.dataset.seatid = seatId;
        seat.dataset.code = seatCode;
        seat.textContent = seatCode;
        seat.title = `Khemah ${k} â€” Meja ${m} â€” Kerusi ${s}`;
        seat.addEventListener('click', onSeatClick);
        table.appendChild(seat);
      }

      inner.appendChild(table);
    }

    row.appendChild(tent);
  });

  // after constructing DOM, mark booked seats
  markBookedAndSelected();
}

/* ========== MARK / TOGGLE ========== */
function markBookedAndSelected(){
  document.querySelectorAll('.seat').forEach(el=>{
    const id = el.dataset.seatid;
    el.classList.remove('booked','selected');
    if(serverBooked.has(id)) el.classList.add('booked');
    else if(selectedSeats.has(id)) el.classList.add('selected');
  });
  updateSelectedSummary();
}

function onSeatClick(e){
  const el = e.currentTarget;
  if(el.classList.contains('booked')){ alert('Maaf, kerusi telah ditempah.'); return; }
  const id = el.dataset.seatid;
  if(selectedSeats.has(id)){ selectedSeats.delete(id); el.classList.remove('selected'); }
  else { selectedSeats.add(id); el.classList.add('selected'); }
  updateSelectedSummary();
}

function updateSelectedSummary(){
  const el = $('#selectedSummary');
  if(!el) return;
  if(selectedSeats.size === 0) el.textContent = 'Tiada kerusi dipilih.';
  else el.textContent = `Kerusi dipilih: ${Array.from(selectedSeats).join(', ')} â€” Jumlah RM${selectedSeats.size * PRICE}`;
}

/* ========== LOAD BOOKED FROM SERVER ========== */
/*
  The server returns objects (getAll) â€” to be robust we accept either:
  - [{seat: 'K17', ...}, ...]  OR
  - array rows like [ [date, 'K17', ...], ... ]
  We convert stored 'K17' -> internal id 'K-T1-S7'
*/
async function loadBookedFromServer(){
  try{
    const resp = await fetch(WEBAPP_URL + '?action=getAll', { cache: 'no-store' });
    const data = await resp.json();

    const seats = new Set();
    if(Array.isArray(data)){
      data.forEach(item => {
        let seatCode = null;
        if(typeof item === 'object' && item !== null && ('seat' in item || 'kod' in item || 'seatCode' in item)){
          seatCode = item.seat || item.kod || item.seatCode || '';
        } else if(Array.isArray(item)){
          // row array: assume column 1 is Kod Kerusi
          seatCode = item[1] || '';
        } else if(typeof item === 'string'){
          seatCode = item;
        }
        seatCode = String(seatCode || '').trim();
        if(!seatCode) return;
        // transform K17 -> K-T1-S7
        const k = seatCode.charAt(0);
        const rest = seatCode.slice(1);
        if(rest.length >= 2){
          const meja = rest.charAt(0);
          const kerusi = rest.slice(1);
          const id = `${k}-T${meja}-S${kerusi}`;
          seats.add(id);
        }
      });
    }
    serverBooked = seats;
    // update UI
    markBookedAndSelected();
  }catch(err){
    console.warn('Gagal muat status dari server:', err);
  }
}

/* ========== SUBMIT BOOKING ========== */
async function submitBooking(){
  if(selectedSeats.size === 0){ alert('Sila pilih sekurang-kurangnya satu kerusi.'); return; }
  const name = $('#fName').value.trim();
  const phone = $('#fPhone').value.trim();
  const batch = $('#fBatch').value.trim();
  const resit = ($('#fResit').value || '').trim().toUpperCase();

  if(!name || !phone || !batch){ alert('Sila lengkapkan Nama, Telefon dan Batch.'); return; }
  if(!/^STS100B\d{3}$/.test(resit) || parseInt(resit.replace('STS100B','')) < 1 || parseInt(resit.replace('STS100B','')) > 160){
    alert('âš ï¸ Nombor resit tidak sah untuk Pakej B.'); return;
  }

  const bookingCode = 'STS100B-' + Math.random().toString(36).slice(2,8).toUpperCase();
  const seatsArray = Array.from(selectedSeats);

  let okCount = 0, dupCount = 0, failCount = 0;

  for(const seatId of seatsArray){
    // seatId format K-T1-S7
    const parts = seatId.split('-');
    const khemah = parts[0];
    const meja = parts[1].replace('T','');
    const kerusi = parts[2].replace('S','');

    const params = new URLSearchParams({
      nama: name,
      telefon: phone,
      batch: batch,
      resit: resit,
      khemah: khemah,
      meja: meja,
      kerusi: kerusi,
      harga: PRICE,
      kod_tempahan: bookingCode
    });

    try{
      const resp = await fetch(WEBAPP_URL + '?' + params.toString(), { method: 'GET' });
      const txt = (await resp.text()).trim();
      if(txt === 'OK' || txt.includes('OK')) {
        okCount++;
      } else if(txt === 'DUPLICATE' || txt.includes('DUPLICATE')) {
        dupCount++;
      } else if(txt === 'INVALID_RECEIPT' || txt.includes('INVALID_RECEIPT')) {
        alert('âš ï¸ Nombor resit tidak sah (server). Tempahan dibatalkan.');
        failCount += 1;
      } else {
        console.warn('Server response (unknown):', txt);
        failCount++;
      }
    }catch(err){
      console.error('Network error', err);
      failCount++;
    }
  }

  // results
  if(okCount > 0){
    alert(`âœ… Tempahan berjaya untuk ${okCount} kerusi. Kod Tempahan: ${bookingCode}`);
  }
  if(dupCount > 0){
    alert(`âš ï¸ ${dupCount} kerusi telah ditempah oleh orang lain (duplicate).`);
  }
  if(okCount === 0 && failCount > 0){
    alert('âŒ Tiada tempahan berjaya. Sila cuba lagi kemudian.');
  }

  // refresh state and UI
  selectedSeats.clear();
  $('#bookingBackdrop').style.display = 'none';
  await loadBookedFromServer();
  // rebuild selection visuals
  markBookedAndSelected();
}

/* ========== ADMIN & DOWNLOAD ========== */
$('#openBookingBtn').addEventListener('click', ()=>{ $('#bookingBackdrop').style.display='flex'; $('#fName').focus(); updateSelectedSummary(); });
$('#bookingCancel').addEventListener('click', ()=>{ $('#bookingBackdrop').style.display='none'; });

$('#refreshBtn').addEventListener('click', ()=>loadBookedFromServer());

$('#adminViewBtn').addEventListener('click', ()=>{ $('#adminBackdrop').style.display='flex'; $('#adminPass').focus(); });
$('#adminCancel').addEventListener('click', ()=>{ $('#adminBackdrop').style.display='none'; $('#adminPass').value=''; });

$('#adminLogin').addEventListener('click', async ()=>{
  const val = $('#adminPass').value;
  if(val !== ADMIN_PASS){ alert('Kata laluan admin salah.'); $('#adminPass').value=''; return; }
  $('#adminBackdrop').style.display='none';
  try{
    const resp = await fetch(WEBAPP_URL + '?action=getAll');
    const data = await resp.json();
    if(!Array.isArray(data) || data.length === 0){ alert('Tiada tempahan.'); return; }
    let msg = 'Ringkasan Tempahan:\\n';
    data.forEach(d=>{
      // support both object or row-array
      const kod = d.kod || d[2] || d[1] || '';
      const nama = d.nama || d[3] || '';
      const seat = d.seat || d[1] || '';
      msg += `${kod} â€” ${nama} â€” ${seat}\\n`;
    });
    alert(msg);
  }catch(err){ alert('Gagal load data: '+err); }
});

$('#downloadBtn').addEventListener('click', async ()=>{
  // fetch all and build CSV
  try{
    const resp = await fetch(WEBAPP_URL + '?action=getAll');
    const data = await resp.json();
    // normalize to rows
    const rows = [['Tarikh','Kod Kerusi','Kod Tempahan','Nama','Telefon','Batch','Resit','Khemah','Meja','Kerusi','Harga','Catatan']];
    data.forEach(r=>{
      if(Array.isArray(r)){
        rows.push(r);
      } else {
        rows.push([r.tarikh || '', r.seat || r.kod || '', r.kod || '', r.nama || '', r.telefon || '', r.batch || '', r.resit || '', r.khemah || '', r.meja || '', r.kerusi || '', r.harga || '', r.catatan || '']);
      }
    });
    const csv = rows.map(row => row.map(cell => `"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'Tempahan_STS100B_All.csv'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 700);
  }catch(err){ alert('Gagal muat turun: '+err); }
});

/* booking form submit */
$('#bookingForm').addEventListener('submit', e => { e.preventDefault(); submitBooking(); });

/* ========== INIT ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  buildTentsRow();
  loadBookedFromServer();
  // auto refresh booked status every 30s
  setInterval(loadBookedFromServer, 30000);
});
</script>
</body>
</html>
